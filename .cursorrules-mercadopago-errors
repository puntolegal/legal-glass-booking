# üîç Reglas de Detecci√≥n de Errores - MercadoPago CheckoutPro
# Punto Legal - Sistema de Agendamiento

## ‚ö†Ô∏è PATRONES CR√çTICOS DE ERROR

### 1. **URL del backend mal configurada** [CRITICAL]
**Patr√≥n:** `localhost:3001`, `localhost:5173`, `127.0.0.1`
**Archivos afectados:** `src/pages/PaymentSuccessPage.tsx`, `src/components/MercadoPago*.tsx`
**S√≠ntomas:** `GET http://localhost:3001/payment/... net::ERR_CONNECTION_REFUSED`
**Soluci√≥n:** Usar `https://www.puntolegal.online` en producci√≥n

### 2. **Falta de external_reference** [HIGH]
**Patr√≥n:** `storedReservationId: null`, `storedExternalReference: null`
**Archivos afectados:** `src/services/mercadopagoDirect.ts`, `supabase/functions/create-mercadopago-preference/`
**S√≠ntomas:** "No se encontr√≥ la reserva asociada al pago"
**Soluci√≥n:** Asegurar que `external_reference` se pase en la preferencia

### 3. **Dependencia de localStorage** [HIGH]
**Patr√≥n:** `Datos de pago almacenados: null`, `localStorage.getItem.*null`
**Archivos afectados:** `src/pages/PaymentSuccessPage.tsx`
**S√≠ntomas:** Datos perdidos al volver de MercadoPago
**Soluci√≥n:** Usar b√∫squeda por `preference_id` o `external_reference`

### 4. **Consultas directas a MP desde cliente** [MEDIUM]
**Patr√≥n:** `MERCADOPAGO_ACCESS_TOKEN.*undefined`, `Access token.*no configurado`
**Archivos afectados:** `src/services/mercadopagoPaymentInfo.ts`
**S√≠ntomas:** "usando datos simulados"
**Soluci√≥n:** Usar Edge Functions para consultas a MercadoPago

### 5. **Webhook no configurado** [HIGH]
**Patr√≥n:** `notification_url.*undefined`, `webhook.*failed`
**Archivos afectados:** `supabase/functions/mercadopago-webhook/`
**S√≠ntomas:** Pagos aprobados pero reservas pendientes
**Soluci√≥n:** Verificar `notification_url` en preferencias

### 6. **Ambiente dev mezclado con prod** [CRITICAL]
**Patr√≥n:** `http://localhost`, `Warning: URLs HTTP`
**Archivos afectados:** `src/config/mercadopago.ts`, `.env*`
**S√≠ntomas:** `auto_return invalid`, errores de CORS
**Soluci√≥n:** Usar variables de entorno de producci√≥n

### 7. **Fallbacks en producci√≥n** [MEDIUM]
**Patr√≥n:** `usando datos simulados`, `datos simulados`
**Archivos afectados:** `src/services/*.ts`
**S√≠ntomas:** Usuario ve informaci√≥n gen√©rica
**Soluci√≥n:** Desactivar fallbacks en builds de producci√≥n

## üîß REGLAS DE VALIDACI√ìN

### URLs de Producci√≥n
```typescript
// ‚úÖ CORRECTO
const PRODUCTION_URL = 'https://www.puntolegal.online';
const WEBHOOK_URL = 'https://qrgelocijmwnxcckxbdg.supabase.co/functions/v1/mercadopago-webhook';

// ‚ùå INCORRECTO
const DEV_URL = 'http://localhost:3001';
const LOCAL_WEBHOOK = 'http://localhost:3001/api/webhook';
```

### External Reference
```typescript
// ‚úÖ CORRECTO
const preferenceData = {
  external_reference: reservation.id,
  notification_url: WEBHOOK_URL,
  back_urls: {
    success: `${PRODUCTION_URL}/payment-success?source=mercadopago`
  }
};

// ‚ùå INCORRECTO
const preferenceData = {
  // Sin external_reference
  back_urls: {
    success: 'http://localhost:3001/success' // localhost en producci√≥n
  }
};
```

### B√∫squeda de Reservas
```typescript
// ‚úÖ CORRECTO
const reserva = await findReservaByCriteria({ 
  external_reference: externalReferenceFromURL 
});

// ‚ùå INCORRECTO
const reserva = localStorage.getItem('reservationData'); // Dependencia de localStorage
```

## üìä MONITOREO AUTOM√ÅTICO

### Scripts de Verificaci√≥n
- `node scripts/error-pattern-detector.mjs` - Detectar patrones en c√≥digo
- `node scripts/realtime-error-monitor.mjs` - Monitoreo en tiempo real
- `node scripts/verify-rls-fix.mjs` - Verificar seguridad RLS

### Archivos de Reporte
- `error-patterns-report.json` - Patrones detectados
- `system-health-report.json` - Estado del sistema

## üö® ALERTAS CR√çTICAS

Si detectas alguno de estos patrones, aplicar inmediatamente:

1. **localhost en producci√≥n** ‚Üí Cambiar a URLs de producci√≥n
2. **external_reference faltante** ‚Üí Agregar en creaci√≥n de preferencia
3. **localStorage como √∫nica fuente** ‚Üí Implementar b√∫squeda por ID
4. **webhook fallando** ‚Üí Verificar Edge Function
5. **fallbacks activos** ‚Üí Desactivar en producci√≥n

## ‚úÖ CHECKLIST DE VALIDACI√ìN

Antes de cada deploy verificar:
- [ ] URLs son de producci√≥n (https://www.puntolegal.online)
- [ ] external_reference se pasa correctamente
- [ ] webhook URL configurada
- [ ] Sin dependencias de localStorage
- [ ] Edge Functions operativas
- [ ] Variables de entorno correctas
- [ ] Fallbacks desactivados en producci√≥n
